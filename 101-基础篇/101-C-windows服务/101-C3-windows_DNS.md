# Windows_DNS搭建

## 1.准备工作	

VirtualBox虚拟机，还原windows server 2019第一次快照,win10与server2019处于一个网段中

## 2.DNS详解

### 2.1域名系统

域名系统概述：

​	域名系统DNS(Domain Name System)是因特网使用的命名系统，用来把便于人们使用的机器名字转换成为IP地址。

​	我们都知道，IP地址是由32位的二进制数字组成的。用户与因特网上某台主机通信时，显然不愿意使用很难记忆的长达32位的二进制主机地址。即使是点分十 进制IP地址也并不太容易记忆。相反，大家愿意使用比较容易记忆的主机名字。但是，机器在处理IP数据报时，并不是使用域名而是使用IP地址。这是因为 IP地址长度固定，而域名的长度不固定，机器处理起来比较困难。

​	因为因特网规模很大，所以整个因特网只使用一个域名服务器是不可行的。因此，早在1983年因特网开始采用层次树状结构的命名方法，并使用分布式的域名系 统DNS。并采用客户服务器方式。

​	DNS使大多数名字都在本地解析(resolve)，仅有少量解析需要在因特网上通信，因此DNS系统的效率很高。由于 DNS是分布式系统，即使单个计算机除了故障，也不会妨碍整个DNS系统的正常运行。

​	域名到IP地址的解析是由分布在因特网上的许多域名服务器程序共同完成的。域名服务器程序在专设的结点上运行，而人们也常把运行域名服务器程序的机器称为域名服务器。

### 2.2域名结构

![image-20220330111604075](../../images/image-20220330111604075.png)

### 2.3主机查询顺序

1 本地文件 
c:\windows\system32\drivers\etc\hosts

2 DNS缓存
清除缓存：ipconfig/flushdns

3 DNS服务器

## 3.DNS服务器安装

首先为DNS服务器指定静态IP 地址,dns地址设为本机ip

![image-20220330152305950](../../images/image-20220330152305950.png)

打开服务器管理器，选择添加角色和功能

![image-20220330152446339](../../images/image-20220330152446339.png)

安装类型与安装服务器默认选择下一步即可,服务器角色处点击“DNS服务器”，在弹出的功能选择处点击添加功能,然后点击下一步

![image-20220330152547497](../../images/image-20220330152547497.png)

默认选择下一步

![image-20220330152616650](../../images/image-20220330152616650.png)

显示注意事项,下一步即可

![image-20220330152648169](../../images/image-20220330152648169.png)

检查安装所选内容，勾选如果需要,自动重新启动目标服务器,确认后点击安装

![image-20220330152724322](../../images/image-20220330152724322.png)

安装成功

![image-20220330152920886](../../images/image-20220330152920886.png)

## 4.使用PowerShell安装DNS

ipconfig查看ip地址

![image-20220330153547453](../../images/image-20220330153547453.png)

设置dns地址为本机ip,因为无法响应会报错,但是设置是成功的

`netsh interface ip set dns Ethernet0 static 192.168.176.132`

![image-20220330154253561](../../images/image-20220330154253561.png)

查看与dns相关的服务
`Get-WindowsFeature |where {$_.name -like "*dns*"}`

![image-20220330154431211](../../images/image-20220330154431211.png)

安装与dns相关的所有服务
`Get-WindowsFeature |where {$_.name -like "*dns*"} |Add-WindowsFeature`

![image-20220330154530557](../../images/image-20220330154530557.png)

在此查看与dns相关的服务,发现在头部已经有了X标示,证明已经安装

`Get-WindowsFeature |where {$_.name -like "*dns*"}`

![image-20220330154620840](../../images/image-20220330154620840.png)

## 5.DNS的配置与使用

5.1点击服务器管理器右上角工具,选择DNS

![image-20220330155357088](../../images/image-20220330155357088.png)

创建一个正向查找区域：

1、在正向查找区域处右键,点击新建区域

![image-20220330155545303](../../images/image-20220330155545303.png)

2、运行新建区域向导,下一步即可

![image-20220330155620802](../../images/image-20220330155620802.png)

**DNS区域类型**

主要区域：

​	主要区域是用来存储此区域内所有记录的正本。用户可以在主要区域内新建、修改、删除记录。如果DNS服务器是独立服务器或成员服务器，则区域记录存储在“区域文件”内，文件名默认为“区域名称.dns”，如区域的名称为“lab302.physics.szu，则区域文件名称默认为lab302.physics.szu.dns。区域文件位于%systemroot%\system32\dns文件夹内。如果DNS服务器是域控制器，则可以将区域文件存储在“区域文件”内或活动目录数据库内。如果存放在活动目录数据库内，则此区域内的记录会随着活动目录数据库的复制动作，自动复制到其他域控制器。

辅助区域（secondary zone）：

​	辅助区域内的每一项记录都存储在“区域文件”中，他存储的是此区域内所有记录的副本，该副本信息是利用“区域复制”的方式从“master 服务器”拷贝过来的。辅助区域的记录是只读的。

存根区域(stub zone)：

​	存根区域存储这一个区域的副本信息。与辅助区域不同的是，存根区域只有少量的记录，利用这些记录可以找到此区域的授权服务器。(主要包含NS和SOA记录及NS相关的A记录）虽然我不能解析你要的域名到IP，但是，我知道这个区域的NS是哪台，它可以解析。



在这里我们选择选择“主要区域”,然后点击下一步

![image-20220330160043424](../../images/image-20220330160043424.png)

填写区域名称，如farmsec.com,然后点击下一步

![image-20220330160123315](../../images/image-20220330160123315.png)

确认创建区域
新建区域之后会在 C:\Windows\system32\dns\ 生成相应文件

![image-20220330160220546](../../images/image-20220330160220546.png)

选择“不允许动态更新”,然后点击下一步

![image-20220330160259880](../../images/image-20220330160259880.png)

点击完成即可关闭向导并创建新的区域

![image-20220330160329752](../../images/image-20220330160329752.png)

单击打开区域，右键选择新建主机（A记录）,并指定IP 地址

![image-20220330161135058](../../images/image-20220330161135058.png)

创建成功

![image-20220330163228879](../../images/image-20220330163228879.png)

在win10的网络设置中,将DNS设置为dns服务器地址

![image-20220330163358675](../../images/image-20220330163358675.png)

ping test.farmsec.com 成功解析为服务器设置的A记录地址,说明Dns解析成功

![image-20220330163519415](../../images/image-20220330163519415.png)

## 6.DNS补充与回顾

1 hosts文件
2 清除缓存的校验
3 转发器
4 反向解析
注意事项:
新建邮件交换器时，不填主机或子域的话,邮件地址为:xxx@farmsec.com
填写主机或子域为mail的话,邮件地址为:xxx@mail.farmsec.com

![image-20220330163610533](../../images/image-20220330163610533.png)
